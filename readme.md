Ecrire un Smart-Contract pour cr√©er ses premiers NFTs
=====================================================


L'article complet et reformatt√© est disponibles √† [cette addresse ](https://medium.com/@asertu3/ecrire-un-smart-contract-pour-cr%C3%A9er-ses-premiers-nfts-eb0b364b8954)  sur Medium : 
----

Vous n‚Äôavez pas pu louper la folie des NFTs qui a agit√© investisseurs et m√©dias depuis 2021. Bien qu‚Äôexistant depuis quelques ann√©es, le confinement nous a laiss√© sur les bras des revenus impossible √† d√©penser dans nos occupations habituelles, et beaucoup se sont tourn√©s vers des actifs intangibles : des titres de propri√©t√©s d‚Äôobjets num√©riques garantis par la blockchain, les fameux NFTs.

Ce tutoriel va vous aider √† comprendre comment ils fonctionnent d‚Äôun point de vue technique, en cr√©ant votre premi√®re collection. Il s‚Äôagit d‚Äôun Smart-Contrat, qui poss√®de des attributs permettant de tracer dans un registre l‚Äôappartenance √† des objets pr√©d√©finis.

Pr√©requis
=========

Vous aurez besoin de conna√Ætre les bases de Solidity et l‚Äôoutil Remix. Vous trouverez un tutoriel par rapport √† ce dernier sur mon pr√©c√©dent post. Vous aurez aussi besoin d‚Äôun wallet du type Metamask.

> ‚ÑπÔ∏è ‚Äî Pour des questions de praticit√©, nous allons d√©ployer notre collection de NFT sur la blockchain Polygon, elle permet d‚Äôavoir plus de rapidit√© dans les transactions et les co√ªts sont moins √©lev√©s.

Nous allons proc√©der en diff√©rentes √©tapes dans ce tutoriel :

*   Cr√©ation du smart-contrat de notre NFT
*   Upload de nos ≈ìuvres sur IPFS
*   Cr√©ation et approvisionnement d‚Äôun wallet sur l‚Äôenvironnement de test de la blockchain Polygon
*   Initialisation du contrat
*   D√©couverte d‚ÄôOpenSea

Cr√©ation du Smart-Contrat
=========================

Dans cette premi√®re partie, nous allons cr√©er le code qui nous permettra de d√©finir ces jetons non fongibles. En r√©alit√©, la majeure partie du code a d√©j√† √©t√© √©crite, et plut√¥t que de r√©inventer la roue, nous allons r√©utiliser du code d√©j√† audit√© et donc sans faille connue √† ce jour comme base pour cr√©er nos NFTs. Le code d‚Äôun contrat g√©rant ces NFTs est un standard dans la communaut√© Ethereum qui porte le doux nom de contrat ECR-721.

Commen√ßons la pratique :

> üìå Allez dans Remix et cr√©er un nouveau Workspace tir√© du template ERC-721 :

[Remix - Ethereum IDE](https://remix.ethereum.org/)Cr√©ation de projet ERC-721

Certaines fonctions peuvent √™tre impl√©ment√©es en cochant simplement ces cases. Pour nous faciliter le travail, nous allons importer les attributs suivants :

*   _Mintable_ importe les fonctions nous permettant de g√©rer le _Mint_, c‚Äôest √† dire g√©n√©ration des tokens.
*   _Burnable_ importe les fonctions li√©es √† la destruction des tokens.

Initialisation du code

Une fois cr√©√©, votre fichier _MyToken_ est cr√©√©. Analysons ce code, il y a trois parties importantes :

*   La gestion des biblioth√®ques externes, qui contient les standards de gestion de contrat ERC721;
*   L‚Äôinitialisation du contrat qui contient le nom et les initiales du jeton cr√©√©. Vous pouvez les modifier si vous le d√©sirez;
*   Une fonction a √©t√© automatiquement initialis√©e : _\_safeMint(address, uint256)_ qui nous permet de cr√©er un token, √† partir de deux param√®tres : l‚Äôadresse du futur propri√©taire de l‚Äôobjet qui sera cr√©√© et le num√©ro de cet objet.

Nous avons la base, mais manquons encore de fonctions pour cr√©er nos premiers NFTs. Vous allez avoir besoin de quelques biblioth√®ques en plus,

> üìå Ajoutez ces importations au d√©but du code :

```
import "@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol";  
import "@openzeppelin/contracts/utils/Counters.sol"; 
```

Elles nous permettent de r√©cup√©rer des fonctions cl√©s pour le stockage des images et leurs caract√©ristiques. Notre contrat doit ensuite h√©riter de ces importations, la ligne de d√©claration de contrat devient :

```
contract MyToken is ERC721, ERC721Burnable, ERC721URIStorage, Ownable {
```

Enfin tous ces h√©ritages nous obligent √† cr√©er certaines fonctions et attributs √† notre contrat pour qu‚Äôil puisse fonctionner correctement,

> üìå Ajoutez les fonctions suivantes pour avoir un contrat standard ERC721

*   Un compteur de nombre de NFT g√©n√©r√©s

```
using Counters for Counters.Counter;  
Counters.Counter private _tokenIdCounter;
```

*   Une fonction de desctruction :

```
 function _burn(uint256 tokenId) internal override(ERC721, ERC721URIStorage) {  
        super._burn(tokenId);  
   }
```

*   Une fonction pour r√©cup√©rer le contenu de nos NFTs.

```
function tokenURI(uint256 tokenId)  
        public  
        view  
        override(ERC721, ERC721URIStorage)  
        returns (string memory)  
    {  
        return super.tokenURI(tokenId);  
    }  
}
```

Vous pouvez d‚Äôores et d√©j√† compiler et d√©ployer votre contrat dans un environnement virtuel pour commencer √† interagir avec.

> üìå Explorez toutes les fonctions et essayer de comprendre √† quoi elles peuvent bien servir.

Interface de votre contrat ERC721 dans Remix

Vous pouvez _Minter_ (g√©n√©rer) un NFT en utilisant la fonction _safe_mint_, en mettant en param√®tre l‚Äôadresse qui vous a servi √† d√©ployer dans Remix, et le num√©ro 0 : l‚Äôidentifiant du NFT que vous voulez g√©n√©rer. Observez maintenant le solde de votre compte avec la fonction _BalanceOf_, vous devriez voir que vous avez 1 token associ√© √† votre compte.

F√©licitations, vous √™tes propri√©taire d‚Äôun NFT ! Allons voir ce qu‚Äôil contient en appliquant la fonction _TokenURI_ avec le num√©ro de ce NFT (0).

C‚Äôest une cha√Æne de caract√®re vide, pas tr√®s int√©ressante‚Ä¶

Contenu de votre jeton

> üìå Maintenant, essayez de minter de nouveau le NFT ayant pour id 0.

Vous devriez voir une belle erreur, en effet un NFT est unique et ne peut pas √™tre dupliqu√©, d‚Äôo√π l‚Äôerreur. Nous allons donc cr√©er une fonction de cr√©ation de jeton plus s√©curis√©e, pour √©viter ce genre de m√©saventure.

> üìå Essayez d‚Äô√©crire le code tout seul, vous aurez besoin d‚Äôune fonction _safe_mint(address)_ qui cr√©√© un jeton vers une adresse entr√©e en param√®tres, ce jeton portera pour identifiant le 1er num√©ro disponible. Vous pouvez aussi d√©finir un nombre maximal de jetons qu‚Äôil est possible de cr√©er dans votre contrat, on ne devrait pas pouvoir en cr√©er plus.
> 
> A vos clavier !

üîç Voici la solution

```
uint256 MAX_SUPPLY = 6;  
  
    function safeMint(address to) public {  
        // Le compteur v√©rifie le num√©ro de jeton actuel  
        uint256 tokenId = _tokenIdCounter.current();  
        require(tokenId <= MAX_SUPPLY, "Plus de tokens disponibles" );  
        // On l'incr√©mente pour le prochain jeton   
        _tokenIdCounter.increment();  
        // Il cr√©√© le token, en appelant la fonction _safeMint  
        _safeMint(to, tokenId);  
    }
```

A pr√©sent, vous ne pouvez plus cr√©er deux fois le m√™me NFT, vous pouvez essayez !

Nous allons dans la partie suivante, ajouter du contenu √† nos jetons.

Ajouter des fichiers sur l‚ÄôIPFS
===============================

Notre contrat ERC-721 sera d√©ploy√© sur la blockchain Polygon et aussi longtemps qu‚Äôelle aura des utilisateurs, ce contrat sera accessible. En revanche, comment faire pour que l‚Äôimage et le contenu de nos NFTs le soient aussi ?

Logo de l‚ÄôIPFS

Le syst√®me de fichier interplan√©taire (IPFS) peut nous aider √† r√©pondre √† cette probl√©matique. Il s‚Äôagit d‚Äôun r√©seau de stockage en _pair √† pair_ qui nous permet d‚Äôuploader des fichiers et de les rendre accessibles dans le monde entier via une URL. C‚Äôest sur ce r√©seau que nous allons d√©ployer les images de nos NFTs, pr√©parez toutes les images √† uploader dans un dossier. Renommez vos images de telle sorte que leurs noms ne soient plus qu‚Äôun num√©ro et l‚Äôextension du fichier (exemple 0.jpeg, 1.jpeg, 2.jpeg, etc‚Ä¶) Cela permettra √† votre smart-contrat de toujours savoir quel est le prochain fichier √† utiliser pour une nouvelle image.

Ensuite, vous devrez t√©l√©charger la derni√®re version du logiciel vous permettant de faire cet upload :

[Releases ¬∑ ipfs/ipfs-desktop](https://github.com/ipfs/ipfs-desktop/releases)

> üìå Installez le logiciel adapt√© √† votre syst√®me d‚Äôexploitation.
> 
> Ô∏è ‚ÑπÔ∏è ‚Äî Pour des questions de simplicit√©, nous utiliserons le logiciel √† t√©l√©charger sur votre OS, mais sachez qu‚Äôil existe d‚Äôautre mani√®re d‚Äôutiliser l‚ÄôIPFS.

Application de bureau de IPFS

> üìå Allez dans la section _File_ de votre logiciel et cliquez sur _importer_, s√©lectionnez le dossier contenant vos images, et HOP, elles sont d√©sormais dans l‚ÄôIPFS. De mon c√¥t√©, je vais y d√©poser 6 images en _.jpg_ cr√©√©es par un talentueux ami graphiste.

Import des images dans l‚ÄôIPFS

Pour obtenir les liens d‚Äôacc√®s √† vos images, vous pouvez simplement copiez le lien avec _share link_ ou _partager le lien_, du dossier que vous venez de transf√©rer, il vous permet de trouver l‚ÄôURL √† laquelle votre dossier est accessible. Le premier fichier de ce dossier est accessible √† ce lien auquel on ajoute : ‚Äú/‚Äù + le nom de votre fichier . Par exemple le lien que m‚Äôa g√©n√©r√© IPFS pour mon fichier est : [https://ipfs.io/ipfs/QmQeHsZjRuH4hGHGUojH5JeVUZXdyBxPGCuAG52EZSbBZ5](https://ipfs.io/ipfs/QmQeHsZjRuH4hGHGUojH5JeVUZXdyBxPGCuAG52EZSbBZ5), donc ma premi√®re image sera acessible ici : [https://ipfs.io/ipfs/QmQeHsZjRuH4hGHGUojH5JeVUZXdyBxPGCuAG52EZSbBZ5/0.jpg](https://ipfs.io/ipfs/QmQeHsZjRuH4hGHGUojH5JeVUZXdyBxPGCuAG52EZSbBZ5/0.jpg)

> Ô∏è ‚ÑπÔ∏è ‚Äî Vous pouvez utiliser les 6 images import√©es par mes soins pour votre exercice.

Maintenant, nous allons lier les NFTs vides du smart-contract √† ces images fra√Æchement upolad√©es. Nous allons pour cela √©crire une fonction g_etTokenURI(uint256)_ qui permet, √† partir d‚Äôun _tokenId_, de g√©n√©rer la cha√Æne de caract√®re d√©crivant le nouveau token.

Exercice 1
----------

> üìå Vous allez essayer d‚Äô√©crire la fonction tout seuls avec un peu d‚Äôaide. Voici la structure de la fonction :

```
function getTokenURI(uint256 tokenId) public pure returns (string memory){  
        bytes memory dataURI = abi.encodePacked(  
            '{',                  
                '"name": //A compl√©ter : Trouvez un nom pour l image                 
                '"description": //A compl√©ter :description de la collection   
                '"image": //A compl√©ter :Ecrivez ici le lien de votre image pour le tokenId donn√©  
            '}'  
        );  
        return string(  
            abi.encodePacked(  
                "data:application/json;base64,",  
                Base64.encode(dataURI)  
            )  
        );  
    }
```

Pour utiliser la fonction _Base64.encode_, il vous faudra utiliser la ligne d‚Äôimport suivante pour ajouter le module √† votre contrat, rangez la avec les autres lignes d‚Äôimport.

```
import "@openzeppelin/contracts/utils/Base64.sol";
```

La fonction _GetTokenURI(uint256)_ doit renvoyer le contenu du token, qui n‚Äôest autre qu‚Äôune cha√Æne de caract√®re au format JSON avec trois param√®tres:

*   le nom du token (nous l‚Äôappellerons ‚Äú#N¬∞TOKEN‚Äù)
*   Une rapide description de la collection.
*   l‚Äôimage, qui sera le lien IPFS de l‚Äôimage ayant pour identifiant ce num√©ro. Voici plusieurs aides pour votre code :

> Ô∏è ‚ÑπÔ∏è ‚Äî La fonction _abi.encodePacked(string)_, prend en parm√®tres autant de chaines de caract√®res que n√©cessaire et les concat√®ne entre elles.
> 
> Ô∏è ‚ÑπÔ∏è ‚Äî Il existe une fonction _Strings.toString(uint256)_ qui transforme un uint256 en chaine de caract√®re.
> 
> Ô∏è ‚ÑπÔ∏è ‚Äî Un format valide de JSON est au format ci dessous :

```
{  
"name":"#6",  
"description":"description de votre collection"  
"image":"https://ipfs.io/ipfs/QmQeHsZjRuH4hGHGUojH5JeVUZXdyBxPGCuAG52EZSbBZ5/6.jpg"  
}
```

Exercice 2
----------

> üìå Le second exercice consiste √† compl√©ter la fonction _safe_mint(uint256)_ pr√©c√©demment √©crite pour d√©finir le contenu de notre NFT √† son initialisation. Pour cela, nous allons appeler la fonction :

```
_setTokenURI(tokenId, contenu_du_token)
```

Le contenu du token est celui g√©n√©r√© dans la fonction pr√©c√©demment √©crite.

Essayez maintenant de compl√©ter cette la fonction _safeMint(uint256)_. Elle peut √™tre termin√©e en ajoutant une ou deux lignes √† son code pr√©c√©dent.

Solution
--------

```
 function safeMint(address to) public {  
        // Le compteur v√©rifie le num√©ro de jeton actuel  
        uint256 tokenId = _tokenIdCounter.current();  
        require(tokenId <= MAX_SUPPLY, "Plus de tokens disponibles" );  
        // On l'incr√©mente pour le prochain jeton   
        _tokenIdCounter.increment();  
        // Il cr√©√© le token, en appelant la fonction _safeMint  
        _safeMint(to, tokenId);  
        // select the Uri  
        string memory itemUri = getTokenURI(tokenId);  
        //add it to the token  
        _setTokenURI(tokenId, itemUri);  
    }
```

D√©ploiement
-----------

Vous aviez trouv√© ? F√©licitations ! Vous pouvez d√®s lors essayer de d√©ployer votre nouveau contrat et interagir avec lui. V√©rifiez nottament que vous avez bien une cha√Æne de caract√®re encod√©e en tant que _TokenURI_ du jeton 0.

Interface de Remix avec le contrat complet red√©ploy√©

Bravo ! Vous avez d√©ploy√© votre contrat en local. Passons maintenant au niveau sup√©rieur en d√©ployant ce contrat sur une blockchain de test : _Polygon Mumbai_.

D√©ploiement sur Polygon
=======================

La blockchain Polygon utilise le m√™me moteur d‚Äôinterpr√©tation des smart-contrats qu‚ÄôEthereum et sans rentrer dans trop de d√©tail ici, le code cr√©√© dans la partie pr√©c√©dente de ce tutoriel fonctionnera de la m√™me mani√®re sur Polygon et Ethereum, le premier est cependant est plus rapide et moins on√©reux, mais moins s√©curis√©. C‚Äôest donc le support que nous avons choisi pour nos NFTs.

Afin de d√©ployer sur la blockchain de test de Polygon : _Mumbai_, nous allons y connecter notre wallet (par exemple Metamask), puis y d√©poser des MATICs (monnaie de _Polygon_, √©quivalent √† _l‚ÄôEther_ pour _Ethereum_). Nous pourrons ainsi payer les frais de transactions des op√©rations que nous nous appr√™tons √† r√©aliser sur _Polygon_.

Interface de ChainList

Connectez le r√©seau Mumbai √† votre Wallet
-----------------------------------------

[Chainlist](https://chainlist.org/)

> üìå Pour cela, rendez vous sur le site _ChainList.org_, qui vous permet de connecter facilement un grand nombre de blockchain √† votre wallet. Recherchez le r√©seau _Mumbai_ en prenant soin d‚Äôinclure les testsnets dans la recherche. Cliquez ensuite sur ‚Äú_Connect Wallet_‚Äù puis ‚Äú_Add to Metamask_‚Äù, Signez la transaction sur votre Metamask et changez de r√©seau. Vous avez reli√© votre wallet au Testnet de Polygon !

Ajout de la chaine √† Metamask

Ajout de jetons de paiement sur votre compte Mumbai
---------------------------------------------------

Maintenant, il vous faut des sous ! Allez sur un ‚Äú_faucet_‚Äù, c‚Äôest √† dire un site qui vous donne gratuitement des jetons de paiement pour utiliser testnet. Par exemple, allez sur :

[Polygon Faucet](https://faucet.polygon.technology/)

> üìå Copiez l‚Äôadresse de votre compte Mumbai et entrez la dans l‚Äôadresse du faucet.

Copie de l‚Äôadresse de votre compte Mumbai dans MetamaskInterface du faucet Mumbai

Apr√®s quelques secondes, vous devriez recevoir les jetons pour payer les frais de transaction. Vous √™tes pr√™t √† faire des d√©penses sur le testnet de Polygon.

Initialisation du contrat
=========================

Bien, r√©capitulons, nous avons un contrat pouvant contenir des NFTs li√©s √† des images, nous avons aussi cr√©√© un compte Polygon, sur lequel nous avons des MATICs, qui nous permettent d‚Äôinteragir avec cette blockchain. Si vous avez bien suivi, notre prochaine √©tape est de d√©ployer notre contrat sur cette blockchain.

> üìå En premier lieu, il faut que Remix comprenne sur quel r√©seau nous souhaitons d√©ployer notre contrat, vous devez donc s√©lectionner l‚Äôenvironnement : ‚Äú_Injected Provider ‚Äî Metamask_‚Äù dans l‚Äôonglet ‚Äú_Deploy and Run_‚Äù de remix :

Selection du r√©seau de d√©ploiement sur Remix

Cela permet √† votre wallet de selectionner avec quel r√©seau vous allez interagir.

Cliquez sur ‚Äú_deploy_‚Äù dans Remix, votre Metamask vous demande ensuite de confirmer si vous voulez payer les frais de transaction. Si vous √™tes bien s√ªrs de vous, confirmez.

Demande de confirmation de la transaction dans Metamask

Attendez quelques secondes, puis ‚Ä¶ la transaction est confirm√©e !

> Ô∏è‚Ñπ ‚Äî Il est possible que la transaction ne fonctionne pas si le montant calcul√© par Metamask pour les frais de transaction sont trop faibles. Pour palier √† ce probl√®me, augmentez les frais que vous allez payer en MATICs, en cliquant sur : MODIFIER >> Modifier le prix du carburant sugg√©r√©, et augmentez le montant maximal des frais de transaction, avant de confirmer. R√©p√©tez plusieurs fois cette op√©ration , jusqu‚Äô√† ce que la transaction soit accept√©e. Cela est du au frais de gaz mal calcul√©s par Metamask.

En cas d‚Äôerreur, augmentez la valeur du montant max des frais de transaction

Vous avez d√©ploy√© votre contrat ! D‚Äôores et d√©j√†, le contrat est disponible sur la plateforme PolygonScan :

[TESTNET Polygon (MATIC) Blockchain Explorer](https://mumbai.polygonscan.com/)

C‚Äôest un site qui permet de scanner la blockchain Polygon. Vous connaissez peut-√™tre _Etherscan_ qui permet d‚Äôobserver toutes les transactions qui sont r√©alis√©es dans le r√©seau Ethereum ou d‚Äôobserver le contenu de toutes les addresses du r√©seau, et bien _PolygonScan_ a la m√™me utilit√© sur le r√©seau Polygon.

Vous pouvez trouver l‚Äôadresse √† laquelle se trouve d√©sormais votre contrat sur le r√©seau dans Remix.

Addresse du contrat d√©ploy√© dans remix √† rechercher dans PolygonScan

> üìå Copiez cette adresse pour la rechercher dans PolygonScan. Vous allez √™tre dirig√© sur une page contenant toutes les interactions avec votre contrat. En l‚Äôoccurrence, vous trouverez seulement l‚Äôinitialisation du contrat, car nous avons eu une seule transaction li√©e √† notre contrat.
> 
> üìå Ajoutons une transaction en _mintant_ le premier NFT du contrat. Retournez sur Eemix et utilisez la fonction s_afeMint(address)_, avec l‚Äôadresse de votre compte en param√®tres pour devenir le premier propri√©taire, vous devrez encore une fois payer les frais de transaction.

Vous venez d‚Äôinteragir avec le contrat, vous pouvez aller la voir dans PolygonScan, sur la page du contrat si vous voyez bien cette nouvelle transaction.

Voir nos NFTs dans OpenSea
--------------------------

Pour v√©rifier que tout s‚Äôest bien d√©roul√© et finalement observer notre collection nouvellement cr√©√©e, nous allons utiliser un site bien connu des collectionneurs : _OpenSea_. Ce site scanne les blockchains √† la recherche des contrats respectant la norme ERC-721. OpenSea lit ensuite les informations contenues dans chaque NFT pour nous l‚Äôafficher : son nom, son image, son propri√©taire, etc‚Ä¶

Cherchons notre contrat sur OpenSea. En premier lieu, il faut se rendre sur le site scannant les blockchains de test et rechercher l‚Äôadresse du contrat que nous avons d√©ploy√©.

[https://testnets.opensea.io/fr](https://testnets.opensea.io/fr)

Si tout s‚Äôest d√©roul√© sans encombre, vous devriez voir une page de ce format:

Page de la collection NFT (ou du contrat d√©ploy√©) dans OpenSea

Cliquez sur le premier NFT de la collection afin de voir le d√©tail de cette image. Vous y trouverez les informations √©crites dans l‚ÄôURI de votre jeton, redispos√© dans le site OpenSea. Vous devriez voir que vous √™tes le propri√©taire de ce NFT si vous connectez votre Metamask.

Conclusion
==========

Bravo !! Vous avez fait un excellemment travail, vous avez effectu√© toutes les taches de ce tutoriel. Vous avez √©crit un contrat ERC721, upload√© des fichiers sur l‚ÄôIPFS, d√©ploy√© votre contrat sur le testnet de Polygon et observ√© vos NFTs sur OpenSea.

Il y a encore beaucoup de choses √† d√©couvrir avant de comprendre la densit√© des possibilit√©s des NFTs sur une blockchain, mais ce tutoriel a pu vous permettre de comprendre comment ils fonctionnaient d‚Äôun point de vue technique.

Pour vous donner quelques pistes pour approfondir le sujet sachez que les metadonn√©es peuvent contenir d‚Äôautres informations (nous avions juste un nom, une description et une image), vous pouvez ajouter des √©l√©ments suppl√©mentaires comme un attribut ‚Äúanimal‚Äù, qui prendra la valeur du nom d‚Äôun animal en fonction de ce qui appara√Æt sur l‚Äôimage. Un bon exercice pourrait √™tre d‚Äôuploader des fichiers au format JSONs descriptifs plutot que des images dans l‚ÄôIPFS et de les relier √† vos NFTs pour avoir des compl√©ments sur ce qui appara√Æt dans l‚Äôimage.

Bonne chance pour la suite de vos aventures !

[r/ethdev\_fr](https://www.reddit.com/r/ethdev_fr/)
